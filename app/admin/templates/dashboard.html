<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaSpotter Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* Modern CSS Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Advanced Design System Variables */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #8b5cf6;
            --success: #10b981;
            --success-dark: #059669;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --error: #ef4444;
            --error-dark: #dc2626;
            --info: #06b6d4;

            /* Background Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --bg-accent: #f8fafc;

            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-accent: #6366f1;

            /* Border & Shadow */
            --border: #334155;
            --border-light: #475569;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            --gradient-success: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            --gradient-warning: linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%);
            --gradient-error: linear-gradient(135deg, var(--error) 0%, var(--error-dark) 100%);

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 0.75rem;
            --space-lg: 1rem;
            --space-xl: 1.5rem;
            --space-2xl: 2rem;
            --space-3xl: 3rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-2xl: 2rem;

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 250ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
        }

        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--space-md);
        }

        h1 { font-size: 2rem; }
        h2 { font-size: 1.75rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.25rem; }
        h5 { font-size: 1.125rem; }
        h6 { font-size: 1rem; }

        /* Layout Components */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            padding: var(--space-lg);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Header - Modern Design */
        .header {
            background: var(--gradient-primary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: var(--space-lg) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .logo {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo i {
            color: #fff;
            margin-right: var(--space-sm);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }

        .user-role {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Navigation - Advanced Tab System */
        .nav-container {
            margin-bottom: var(--space-2xl);
        }

        .nav-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-sm);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg) var(--space-md);
            border-radius: var(--radius-lg);
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            min-width: 80px;
            flex: 1;
            position: relative;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 2px;
            transition: var(--transition-normal);
        }

        .nav-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .nav-tab.active::before {
            width: 100%;
        }

        .nav-tab i {
            font-size: 1.5rem;
            margin-bottom: var(--space-xs);
        }

        .nav-tab span {
            font-size: 0.75rem;
            line-height: 1;
            text-align: center;
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid - Advanced Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-3xl);
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            box-shadow: var(--shadow);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.primary { background: var(--gradient-primary); }
        .stat-icon.success { background: var(--gradient-success); }
        .stat-icon.warning { background: var(--gradient-warning); }
        .stat-icon.error { background: var(--gradient-error); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: var(--space-xs);
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: var(--space-sm);
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--error);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
        }

        .btn {
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-error);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-sm {
            padding: var(--space-sm) var(--space-md);
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: var(--space-lg) var(--space-xl);
            font-size: 1rem;
        }

        /* Message Cards - Advanced Design */
        .messages-section {
            margin-bottom: var(--space-3xl);
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        .messages-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }

        .message-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            transition: var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .message-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: var(--transition-normal);
        }

        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .message-card:hover::before {
            opacity: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .message-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .message-status {
            display: inline-flex;
            align-items: center;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-2xl);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-approved {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-posted {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .message-content {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: var(--space-md);
            font-size: 0.95rem;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .message-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .message-actions .btn {
            padding: var(--space-sm) var(--space-md);
            font-size: 0.75rem;
        }

        /* Forms - Modern Design */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: var(--transition-fast);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--space-xs);
        }

        /* Modal System */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: var(--transition-normal);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius);
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-3xl) var(--space-xl);
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl) var(--space-xl);
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: var(--space-md);
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.9rem;
            max-width: 400px;
            margin: 0 auto var(--space-xl);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: var(--space-2xl);
            right: var(--space-xl);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            transform: translateX(400px);
            transition: var(--transition-slow);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification-icon {
            font-size: 1.25rem;
            margin-top: 2px;
        }

        .notification.success .notification-icon {
            color: var(--success);
        }

        .notification.error .notification-icon {
            color: var(--error);
        }

        .notification.warning .notification-icon {
            color: var(--warning);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
        }

        .notification-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: var(--space-md) var(--space-lg);
                flex-direction: column;
                gap: var(--space-md);
            }

            .header-left {
                width: 100%;
                justify-content: center;
            }

            .user-menu {
                justify-content: center;
            }

            .main-content {
                padding: var(--space-md);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }

            .nav-tabs {
                padding: var(--space-xs);
            }

            .nav-tab {
                padding: var(--space-md) var(--space-sm);
                min-width: 70px;
            }

            .nav-tab i {
                font-size: 1.25rem;
            }

            .nav-tab span {
                font-size: 0.7rem;
            }

            .messages-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-md);
            }

            .action-buttons {
                justify-content: center;
            }

            .modal-content {
                padding: var(--space-lg);
                margin: var(--space-md);
            }
        }

        @media (max-width: 480px) {
            .stat-card {
                padding: var(--space-lg);
            }

            .stat-value {
                font-size: 2rem;
            }

            .message-card {
                padding: var(--space-lg);
            }

            .message-actions {
                flex-direction: column;
            }

            .message-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }

        .mb-xs { margin-bottom: var(--space-xs); }
        .mb-sm { margin-bottom: var(--space-sm); }
        .mb-md { margin-bottom: var(--space-md); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .mb-xl { margin-bottom: var(--space-xl); }
        .mb-2xl { margin-bottom: var(--space-2xl); }

        .mt-xs { margin-top: var(--space-xs); }
        .mt-sm { margin-top: var(--space-sm); }
        .mt-md { margin-top: var(--space-md); }
        .mt-lg { margin-top: var(--space-lg); }
        .mt-xl { margin-top: var(--space-xl); }
        .mt-2xl { margin-top: var(--space-2xl); }

        .hidden { display: none; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--space-sm); }
        .gap-md { gap: var(--space-md); }
        .gap-lg { gap: var(--space-lg); }

        /* Animations */
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-8px); }
            70% { transform: translateY(-4px); }
            90% { transform: translateY(-2px); }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus states for keyboard navigation */
        .btn:focus-visible,
        .form-input:focus-visible,
        .form-textarea:focus-visible,
        .form-select:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border: #ffffff;
                --bg-secondary: #000000;
                --bg-tertiary: #1a1a1a;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Modern Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    InstaSpotter
                </div>
            </div>
            <div class="user-menu">
                <div class="user-info">
                    <span class="user-name">{{ username or 'Admin' }}</span>
                    <span class="user-role">Administrator</span>
                </div>
                <div class="user-avatar">{{ (username or 'A')[:1].upper() }}</div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Navigation Tabs -->
            <nav class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-section="dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </button>
                    <button class="nav-tab" data-section="messages">
                        <i class="fas fa-comments"></i>
                        <span>Messaggi</span>
                    </button>
                    <button class="nav-tab" data-section="daily-post">
                        <i class="fas fa-calendar-day"></i>
                        <span>Daily Post</span>
                    </button>
                    <button class="nav-tab" data-section="info-cards">
                        <i class="fas fa-id-card"></i>
                        <span>Info Cards</span>
                    </button>
                    <button class="nav-tab" data-section="settings">
                        <i class="fas fa-cogs"></i>
                        <span>Impostazioni</span>
                    </button>
                </div>
            </nav>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadDashboardData()">
                        <i class="fas fa-sync-alt"></i>
                        Aggiorna Dati
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Esporta Report
                    </button>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +12%
                            </div>
                        </div>
                        <div class="stat-value" id="totalPosts">0</div>
                        <div class="stat-label">Messaggi Totali</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-change">
                                <i class="fas fa-minus"></i>
                                In Attesa
                            </div>
                        </div>
                        <div class="stat-value" id="pendingModeration">0</div>
                        <div class="stat-label">Da Moderare</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +8%
                            </div>
                        </div>
                        <div class="stat-value" id="approvedToday">0</div>
                        <div class="stat-label">Approvati Oggi</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-paper-plane"></i>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +15%
                            </div>
                        </div>
                        <div class="stat-value" id="postedToday">0</div>
                        <div class="stat-label">Pubblicati Oggi</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="messages-section">
                    <div class="messages-header">
                        <h3>Attività Recente</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadDashboardData()">
                            <i class="fas fa-refresh"></i>
                            Aggiorna
                        </button>
                    </div>
                    <div id="recentActivity" class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Caricamento attività recente...</div>
                    </div>
                </div>
            </section>

            <!-- Messages Section -->
            <section id="messages" class="content-section">
                <div class="messages-section">
                    <div class="messages-header">
                        <h3>Gestione Messaggi</h3>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="loadMessages()">
                                <i class="fas fa-sync-alt"></i>
                                Ricarica
                            </button>
                            <button class="btn btn-success" onclick="bulkApprove()">
                                <i class="fas fa-check-double"></i>
                                Approva Tutto
                            </button>
                            <button class="btn btn-danger" onclick="bulkReject()">
                                <i class="fas fa-times-circle"></i>
                                Rifiuta Tutto
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="action-buttons" style="margin-bottom: var(--space-lg);">
                        <button class="btn btn-outline btn-sm" onclick="filterMessages('all')">Tutti</button>
                        <button class="btn btn-outline btn-sm" onclick="filterMessages('pending')">In Attesa</button>
                        <button class="btn btn-outline btn-sm" onclick="filterMessages('approved')">Approvati</button>
                        <button class="btn btn-outline btn-sm" onclick="filterMessages('rejected')">Rifiutati</button>
                    </div>

                    <div id="messagesList" class="messages-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento messaggi...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Daily Post Section -->
            <section id="daily-post" class="content-section">
                <div class="messages-section">
                    <div class="messages-header">
                        <h3>Daily Post Creator</h3>
                        <button class="btn btn-primary" onclick="loadDailyPostSettings()">
                            <i class="fas fa-sync-alt"></i>
                            Ricarica
                        </button>
                    </div>

                    <!-- Settings Card -->
                    <div class="stat-card" style="margin-bottom: var(--space-xl);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">Impostazioni Daily Post</h4>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="dailyPostEnabled" onchange="updateDailyPostSetting('enabled', this.checked)">
                                Abilitato
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Orario Pubblicazione</label>
                            <input type="time" id="dailyPostTime" class="form-input" onchange="updateDailyPostSetting('post_time', this.value)">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Max Messaggi per Post</label>
                            <input type="number" id="maxMessages" class="form-input" min="1" max="20" onchange="updateDailyPostSetting('max_messages', this.value)">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Template Titolo</label>
                            <input type="text" id="titleTemplate" class="form-input" placeholder="Es: Post della giornata #{date}" onchange="updateDailyPostSetting('title_template', this.value)">
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="testDailyPost()">
                                <i class="fas fa-play"></i>
                                Test Daily Post
                            </button>
                            <button class="btn btn-primary" onclick="generateDailyPostNow()">
                                <i class="fas fa-calendar-plus"></i>
                                Genera Ora
                            </button>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="stat-card">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">Statistiche Daily Post</h4>
                        <div id="dailyPostStats" class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento statistiche...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Info Cards Section -->
            <section id="info-cards" class="content-section">
                <div class="messages-section">
                    <div class="messages-header">
                        <h3>Info Cards Creator</h3>
                        <button class="btn btn-primary" onclick="showCreateCardForm()">
                            <i class="fas fa-plus"></i>
                            Crea Nuova Card
                        </button>
                    </div>

                    <!-- Create Card Form (Hidden by default) -->
                    <div id="createCardForm" class="stat-card" style="display: none; margin-bottom: var(--space-xl);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">Crea Info Card</h4>

                        <div class="form-group">
                            <label class="form-label">Titolo</label>
                            <input type="text" id="cardTitle" class="form-input" placeholder="Titolo della card">
                            <div class="form-hint">Il titolo apparirà in grassetto nella card</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Contenuto</label>
                            <textarea id="cardContent" class="form-textarea" placeholder="Contenuto della card..." rows="4"></textarea>
                            <div class="form-hint">Descrivi cosa vuoi comunicare nella card</div>
                        </div>

                        <!-- Live Preview -->
                        <div class="form-group">
                            <label class="form-label">Anteprima Live</label>
                            <div id="cardPreview" style="border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: var(--space-lg); min-height: 150px; background: var(--bg-primary);">
                                <div style="text-align: center; color: var(--text-muted);">
                                    <i class="fas fa-eye fa-2x" style="margin-bottom: var(--space-md);"></i>
                                    <div>L'anteprima apparirà qui mentre digiti</div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="createInfoCard()">
                                <i class="fas fa-save"></i>
                                Crea Card
                            </button>
                            <button class="btn btn-secondary" onclick="hideCreateCardForm()">
                                <i class="fas fa-times"></i>
                                Annulla
                            </button>
                        </div>
                    </div>

                    <!-- Cards List -->
                    <div id="infoCardsList" class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Caricamento cards...</div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="messages-section">
                    <div class="messages-header">
                        <h3><i class="fas fa-cogs"></i> Gestione Sistema Avanzata</h3>
                        <div class="action-buttons">
                            <button class="btn btn-warning btn-sm" onclick="showDangerZone()">
                                <i class="fas fa-exclamation-triangle"></i>
                                Zona Pericolo
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showSystemLogs()">
                                <i class="fas fa-file-alt"></i>
                                Log Sistema
                            </button>
                            <button class="btn btn-success btn-sm" onclick="showBackupManager()">
                                <i class="fas fa-shield-alt"></i>
                                Backup & Sicurezza
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="showAdvancedAuth()">
                                <i class="fas fa-key"></i>
                                Autenticazione
                            </button>
                        </div>
                    </div>

                    <!-- Instagram Settings -->
                    <div class="stat-card" style="margin-bottom: var(--space-xl);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fab fa-instagram" style="color: #E4405F; margin-right: var(--space-sm);"></i>
                            Instagram
                        </h4>
                        <div id="instagramSettings" class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento impostazioni Instagram...</div>
                        </div>

                        <!-- Instagram Settings Form -->
                        <div id="instagramSettingsForm" style="display: none; margin-top: var(--space-lg);">
                            <div class="form-group">
                                <label class="form-label">Username Instagram</label>
                                <input type="text" id="instagramUsername" class="form-input" placeholder="username">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" id="instagramPassword" class="form-input" placeholder="password">
                                <div class="form-hint">La password viene salvata in modo sicuro</div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="saveInstagramSettings()">
                                    <i class="fas fa-save"></i>
                                    Salva Impostazioni
                                </button>
                                <button class="btn btn-secondary" onclick="hideInstagramSettings()">
                                    <i class="fas fa-times"></i>
                                    Annulla
                                </button>
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-md);">
                            <button class="btn btn-primary btn-sm" onclick="showInstagramSettings()">
                                <i class="fas fa-edit"></i>
                                Modifica
                            </button>
                            <button class="btn btn-success btn-sm" onclick="testInstagramConnection()">
                                <i class="fas fa-plug"></i>
                                Test Connessione
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Analytics -->
                    <div class="stat-card" style="margin-bottom: var(--space-xl);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-chart-line" style="color: var(--primary); margin-right: var(--space-sm);"></i>
                            Analytics Avanzati
                        </h4>
                        <div id="advancedAnalytics">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-lg);">
                                <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                    <i class="fas fa-users fa-2x" style="color: var(--primary); margin-bottom: var(--space-sm);"></i>
                                    <div style="font-weight: 600; margin-bottom: var(--space-xs);">Utenti Attivi</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">24h / 7gg / 30gg</div>
                                </div>
                                <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                    <i class="fas fa-chart-bar fa-2x" style="color: var(--success); margin-bottom: var(--space-sm);"></i>
                                    <div style="font-weight: 600; margin-bottom: var(--space-xs);">Performance</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">CPU / RAM / DB</div>
                                </div>
                                <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                    <i class="fas fa-shield-alt fa-2x" style="color: var(--info); margin-bottom: var(--space-sm);"></i>
                                    <div style="font-weight: 600; margin-bottom: var(--space-xs);">Sicurezza</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Login / Errori / Audit</div>
                                </div>
                                <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                    <i class="fas fa-globe fa-2x" style="color: var(--warning); margin-bottom: var(--space-sm);"></i>
                                    <div style="font-weight: 600; margin-bottom: var(--space-xs);">Traffico</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">IP / Geo / Trends</div>
                                </div>
                            </div>
                            <div id="analyticsCharts" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                                <div class="chart-card">
                                    <div class="chart-title">Messaggi per Ora</div>
                                    <div class="chart-container">
                                        <canvas id="messagesHourlyChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-card">
                                    <div class="chart-title">Status Messaggi</div>
                                    <div class="chart-container">
                                        <canvas id="messagesStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-md);">
                            <button class="btn btn-info btn-sm" onclick="generateAnalyticsReport()">
                                <i class="fas fa-file-chart"></i>
                                Report Completo
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="exportAnalyticsData()">
                                <i class="fas fa-download"></i>
                                Esporta Dati
                            </button>
                        </div>
                    </div>

                    <!-- AI Moderation Settings -->
                    <div class="stat-card" style="margin-bottom: var(--space-xl);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-brain" style="color: var(--primary); margin-right: var(--space-sm);"></i>
                            AI Moderation
                        </h4>
                        <div id="geminiSettings" class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento impostazioni AI...</div>
                        </div>

                        <!-- AI Settings Form -->
                        <div id="geminiSettingsForm" style="display: none; margin-top: var(--space-lg);">
                            <div class="form-group">
                                <label class="form-label">API Key Gemini</label>
                                <input type="password" id="geminiApiKey" class="form-input" placeholder="API Key">
                                <div class="form-hint">Chiave API di Google Gemini per la moderazione automatica</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="aiModerationEnabled" onchange="toggleAIModeration(this.checked)">
                                    Abilita Moderazione AI Automatica
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Modello AI</label>
                                <select id="aiModel" class="form-select">
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                </select>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="saveAISettings()">
                                    <i class="fas fa-save"></i>
                                    Salva Impostazioni
                                </button>
                                <button class="btn btn-secondary" onclick="hideAISettings()">
                                    <i class="fas fa-times"></i>
                                    Annulla
                                </button>
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-md);">
                            <button class="btn btn-primary btn-sm" onclick="showAISettings()">
                                <i class="fas fa-edit"></i>
                                Modifica
                            </button>
                            <button class="btn btn-success btn-sm" onclick="testAIConnection()">
                                <i class="fas fa-vial"></i>
                                Test AI
                            </button>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div class="stat-card">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-server" style="color: var(--success); margin-right: var(--space-sm);"></i>
                            Sistema
                        </h4>
                        <div id="systemSettings" class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento informazioni sistema...</div>
                        </div>

                        <!-- System Settings Form -->
                        <div id="systemSettingsForm" style="display: none; margin-top: var(--space-lg);">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="maintenanceMode" onchange="toggleMaintenanceMode(this.checked)">
                                    Modalità Manutenzione
                                </label>
                                <div class="form-hint">Quando abilitata, il sito mostra una pagina di manutenzione</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Messaggi per Ora</label>
                                <input type="number" id="maxMessagesPerHour" class="form-input" min="1" max="100" placeholder="10">
                                <div class="form-hint">Limite massimo di messaggi accettati per ora</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tempo di Sessione (ore)</label>
                                <input type="number" id="sessionTimeout" class="form-input" min="1" max="168" placeholder="24">
                                <div class="form-hint">Ore dopo le quali la sessione admin scade</div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="saveSystemSettings()">
                                    <i class="fas fa-save"></i>
                                    Salva Impostazioni
                                </button>
                                <button class="btn btn-danger" onclick="resetSystemSettings()">
                                    <i class="fas fa-undo"></i>
                                    Reset Default
                                </button>
                                <button class="btn btn-secondary" onclick="hideSystemSettings()">
                                    <i class="fas fa-times"></i>
                                    Annulla
                                </button>
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-md);">
                            <button class="btn btn-primary btn-sm" onclick="showSystemSettings()">
                                <i class="fas fa-edit"></i>
                                Modifica
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="restartApplication()">
                                <i class="fas fa-redo"></i>
                                Riavvia App
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="clearCache()">
                                <i class="fas fa-trash-alt"></i>
                                Svuota Cache
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Data Management -->
                    <div class="stat-card" style="margin-bottom: var(--space-xl);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-database" style="color: var(--info); margin-right: var(--space-sm);"></i>
                            Gestione Dati Avanzata
                        </h4>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg);">
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-search fa-2x" style="color: var(--primary); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Ricerca Avanzata</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Filtra e cerca messaggi</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-trash-bulk fa-2x" style="color: var(--warning); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Cancellazione Bulk</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Elimina messaggi multipli</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-user-shield fa-2x" style="color: var(--success); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Utenti Tecnici</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Gestisci utenti di servizio</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-shield-alt fa-2x" style="color: var(--primary); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Audit Logs</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Log di sicurezza</div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="showAdvancedDataManagement()">
                                <i class="fas fa-tools"></i>
                                Gestione Avanzata Dati
                            </button>
                            <button class="btn btn-success" onclick="showUserManagement()">
                                <i class="fas fa-users-cog"></i>
                                Gestione Utenti
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone (Hidden by default) -->
                <div id="dangerZone" style="display: none; margin-top: var(--space-3xl);">
                    <div class="stat-card" style="border: 2px solid var(--error); background: rgba(239, 68, 68, 0.05);">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--error);">
                            <i class="fas fa-radiation" style="margin-right: var(--space-sm);"></i>
                            🚨 ZONA PERICOLO - OPERAZIONI IRREVERSIBILI 🚨
                        </h4>

                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-lg);">
                            <div style="font-weight: 600; color: var(--error); margin-bottom: var(--space-sm);">
                                <i class="fas fa-exclamation-triangle"></i>
                                ATTENZIONE: Queste operazioni NON possono essere annullate!
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                Prima di procedere, assicurati di avere un backup completo dei dati.
                                Queste azioni elimineranno definitivamente i dati dal database.
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                            <div>
                                <h5 style="color: var(--error); margin-bottom: var(--space-md);">
                                    <i class="fas fa-comments"></i>
                                    Cancella Messaggi
                                </h5>
                                <div class="action-buttons" style="flex-direction: column; gap: var(--space-sm);">
                                    <button class="btn btn-danger btn-sm" onclick="deleteMessagesByStatus('PENDING')">
                                        <i class="fas fa-clock"></i>
                                        Cancella PENDING
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteMessagesByStatus('APPROVED')">
                                        <i class="fas fa-check"></i>
                                        Cancella APPROVED
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteMessagesByStatus('REJECTED')">
                                        <i class="fas fa-times"></i>
                                        Cancella REJECTED
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteAllMessages()">
                                        <i class="fas fa-skull-crossbones"></i>
                                        CANCELLA TUTTI I MESSAGGI
                                    </button>
                                </div>
                            </div>

                            <div>
                                <h5 style="color: var(--error); margin-bottom: var(--space-md);">
                                    <i class="fas fa-server"></i>
                                    Sistema Completo
                                </h5>
                                <div class="action-buttons" style="flex-direction: column; gap: var(--space-sm);">
                                    <button class="btn btn-danger btn-sm" onclick="deleteAllInfoCards()">
                                        <i class="fas fa-id-card"></i>
                                        Cancella Info Cards
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteAllDailyPosts()">
                                        <i class="fas fa-calendar-times"></i>
                                        Cancella Daily Posts
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="resetAllSettings()">
                                        <i class="fas fa-undo-alt"></i>
                                        Reset Impostazioni
                                    </button>
                                    <button class="btn btn-danger" onclick="nuclearOption()" style="background: linear-gradient(45deg, #dc2626, #b91c1c);">
                                        <i class="fas fa-radiation-alt"></i>
                                        🗑️ CANCELLA TUTTO (NUCLEAR)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: var(--space-lg); padding: var(--space-lg); background: rgba(239, 68, 68, 0.05); border: 1px solid var(--error); border-radius: var(--radius-lg);">
                            <div style="font-weight: 600; margin-bottom: var(--space-sm); color: var(--error);">
                                Backup Automatico
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-md);">
                                Prima di qualsiasi operazione distruttiva, viene creato automaticamente un backup.
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="createManualBackup()">
                                    <i class="fas fa-save"></i>
                                    Crea Backup Manuale
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewBackups()">
                                    <i class="fas fa-list"></i>
                                    Visualizza Backup
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="restoreFromBackup()">
                                    <i class="fas fa-undo"></i>
                                    Ripristina da Backup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Manager (Hidden by default) -->
                <div id="backupManager" style="display: none; margin-top: var(--space-3xl);">
                    <div class="stat-card">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-shield-alt" style="color: var(--success); margin-right: var(--space-sm);"></i>
                            Backup & Sicurezza
                        </h4>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-database fa-2x" style="color: var(--success); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Backup Database</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Salva tutto il database</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-images fa-2x" style="color: var(--primary); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Backup Immagini</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Salva tutte le immagini generate</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-file-alt fa-2x" style="color: var(--info); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Backup Config</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Salva configurazione sistema</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-lg); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-cloud-upload-alt fa-2x" style="color: var(--warning); margin-bottom: var(--space-sm);"></i>
                                <div style="font-weight: 600; margin-bottom: var(--space-xs);">Backup Cloud</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Upload su cloud storage</div>
                            </div>
                        </div>

                        <div id="backupStatus" class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento stato backup...</div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-lg);">
                            <button class="btn btn-success" onclick="createFullBackup()">
                                <i class="fas fa-save"></i>
                                Crea Backup Completo
                            </button>
                            <button class="btn btn-primary" onclick="scheduleAutomaticBackup()">
                                <i class="fas fa-clock"></i>
                                Backup Automatico
                            </button>
                            <button class="btn btn-info" onclick="downloadBackup()">
                                <i class="fas fa-download"></i>
                                Scarica Backup
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Logs (Hidden by default) -->
                <div id="systemLogs" style="display: none; margin-top: var(--space-3xl);">
                    <div class="stat-card">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-file-alt" style="color: var(--info); margin-right: var(--space-sm);"></i>
                            Log di Sistema
                        </h4>

                        <div class="form-group">
                            <label class="form-label">Tipo di Log</label>
                            <select id="logType" class="form-select" onchange="loadSystemLogs()">
                                <option value="all">Tutti i Log</option>
                                <option value="error">Errori</option>
                                <option value="warning">Avvertimenti</option>
                                <option value="info">Informazioni</option>
                                <option value="security">Sicurezza</option>
                                <option value="admin">Azioni Admin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Periodo</label>
                            <select id="logPeriod" class="form-select" onchange="loadSystemLogs()">
                                <option value="1h">Ultima ora</option>
                                <option value="24h">Ultime 24 ore</option>
                                <option value="7d">Ultimi 7 giorni</option>
                                <option value="30d">Ultimi 30 giorni</option>
                            </select>
                        </div>

                        <div id="logsContainer" class="loading" style="margin-top: var(--space-lg);">
                            <div class="spinner"></div>
                            <div class="loading-text">Caricamento log di sistema...</div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-lg);">
                            <button class="btn btn-primary" onclick="loadSystemLogs()">
                                <i class="fas fa-sync-alt"></i>
                                Aggiorna Log
                            </button>
                            <button class="btn btn-success" onclick="exportLogs()">
                                <i class="fas fa-download"></i>
                                Esporta Log
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="clearOldLogs()">
                                <i class="fas fa-trash"></i>
                                Pulisci Log Vecchi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Authentication (Hidden by default) -->
                <div id="advancedAuth" style="display: none; margin-top: var(--space-3xl);">
                    <div class="stat-card">
                        <h4 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                            <i class="fas fa-shield-alt" style="color: var(--success); margin-right: var(--space-sm);"></i>
                            Autenticazione Avanzata - QR Code & Passkey
                        </h4>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); margin-bottom: var(--space-xl);">
                            <div style="text-align: center; padding: var(--space-xl); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-qrcode fa-3x" style="color: var(--primary); margin-bottom: var(--space-md);"></i>
                                <h5 style="margin-bottom: var(--space-sm);">Accesso QR Code</h5>
                                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: var(--space-md);">
                                    Genera un codice QR per accedere automaticamente dal cellulare quando sei già loggato dal PC
                                </p>
                                <button class="btn btn-primary" onclick="generateQRCode()">
                                    <i class="fas fa-qrcode"></i>
                                    Genera QR Code
                                </button>
                            </div>

                            <div style="text-align: center; padding: var(--space-xl); background: var(--bg-tertiary); border-radius: var(--radius-lg);">
                                <i class="fas fa-fingerprint fa-3x" style="color: var(--success); margin-bottom: var(--space-md);"></i>
                                <h5 style="margin-bottom: var(--space-sm);">Passkey WebAuthn</h5>
                                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: var(--space-md);">
                                    Autenticazione biometrica sicura senza password usando WebAuthn/FIDO2
                                </p>
                                <button class="btn btn-success" onclick="registerPasskey()">
                                    <i class="fas fa-fingerprint"></i>
                                    Registra Passkey
                                </button>
                            </div>
                        </div>

                        <!-- QR Code Display Area -->
                        <div id="qrCodeArea" style="display: none; text-align: center; margin-bottom: var(--space-xl);">
                            <div style="background: white; padding: var(--space-xl); border-radius: var(--radius-lg); display: inline-block; box-shadow: var(--shadow-lg);">
                                <h5 style="margin-bottom: var(--space-lg); color: var(--text-primary);">Scansiona il QR Code</h5>
                                <div id="qrCodeContainer" style="margin-bottom: var(--space-lg);">
                                    <!-- QR Code will be generated here -->
                                    <div style="width: 256px; height: 256px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                        <div style="color: #666; text-align: center;">
                                            <i class="fas fa-spinner fa-spin fa-2x" style="margin-bottom: 10px;"></i>
                                            <div>Generando QR Code...</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: var(--space-md);">
                                    Scansiona questo codice con il tuo cellulare per accedere automaticamente
                                </div>
                                <div style="font-size: 0.8rem; color: var(--warning);">
                                    <i class="fas fa-clock"></i>
                                    Scade tra <span id="qrCountdown">300</span> secondi
                                </div>
                            </div>
                        </div>

                        <!-- Linked Devices -->
                        <div id="linkedDevicesArea" style="margin-bottom: var(--space-xl);">
                            <h5 style="margin-bottom: var(--space-lg); color: var(--text-primary);">
                                <i class="fas fa-mobile-alt" style="margin-right: var(--space-sm);"></i>
                                Dispositivi Collegati
                            </h5>
                            <div id="devicesList" class="loading">
                                <div class="spinner"></div>
                                <div class="loading-text">Caricamento dispositivi...</div>
                            </div>
                        </div>

                        <!-- Security Settings -->
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: var(--radius-lg); padding: var(--space-lg);">
                            <h5 style="margin-bottom: var(--space-md); color: var(--success);">
                                <i class="fas fa-lock" style="margin-right: var(--space-sm);"></i>
                                Sicurezza Avanzata
                            </h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                                <div>
                                    <label style="display: flex; align-items: center; gap: var(--space-sm); font-weight: 500;">
                                        <input type="checkbox" id="twoFactorEnabled" onchange="toggle2FA(this.checked)">
                                        2FA Abilitato
                                    </label>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: var(--space-xs);">
                                        Autenticazione a due fattori
                                    </div>
                                </div>
                                <div>
                                    <label style="display: flex; align-items: center; gap: var(--space-sm); font-weight: 500;">
                                        <input type="checkbox" id="sessionMonitoring" onchange="toggleSessionMonitoring(this.checked)">
                                        Monitoraggio Sessioni
                                    </label>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: var(--space-xs);">
                                        Alert per accessi sospetti
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-top: var(--space-lg);">
                            <button class="btn btn-info" onclick="showAuthLogs()">
                                <i class="fas fa-history"></i>
                                Log Accessi
                            </button>
                            <button class="btn btn-warning" onclick="revokeAllSessions()">
                                <i class="fas fa-ban"></i>
                                Revoca Tutte le Sessioni
                            </button>
                            <button class="btn btn-danger" onclick="emergencyLockdown()">
                                <i class="fas fa-exclamation-triangle"></i>
                                Lockdown Emergenza
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="notification-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">Notifica</div>
            <div class="notification-message">Operazione completata con successo!</div>
        </div>
    </div>

    <script>
        // Global variables
        let allMessages = [];
        let currentFilter = 'all';

        // Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const sectionId = this.dataset.section;

                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show selected section
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');

                // Load section data
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'messages':
                        loadMessages();
                        break;
                    case 'daily-post':
                        loadDailyPostSettings();
                        break;
                    case 'info-cards':
                        loadInfoCards();
                        break;
                    case 'settings':
                        loadSystemSettings();
                        break;
                }
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');

            // Small delay to allow session to stabilize after login redirect
            setTimeout(() => {
                // Load initial data - authentication will be checked per API call
                loadDashboardData();
                loadSystemSettings();
                loadDailyPostSettings();
                loadInfoCards();
            }, 1000); // 1 second delay

            // Auto-refresh every 30 seconds (starts after initial load)
            setTimeout(() => {
                setInterval(() => {
                    loadDashboardData();
                    console.log('Auto-refresh completed');
                }, 30000);
            }, 5000); // Start auto-refresh after 5 seconds
        });

        // Authentication check
        async function checkAuthentication() {
            try {
                const response = await fetch('/admin/api/dashboard-data?t=' + Date.now());
                return response.status !== 401;
            } catch (error) {
                console.error('Auth check failed:', error);
                return false;
            }
        }

        // API call helper with authentication
        async function apiCall(url, options = {}) {
            const response = await fetch(url, options);
            if (response.status === 401) {
                window.location.href = '/admin/login';
                throw new Error('Not authenticated');
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response;
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                const response = await fetch('/admin/api/dashboard-data?t=' + Date.now(), {
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    console.log('Not authenticated, redirecting to login...');
                    window.location.href = '/admin/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Dashboard data loaded successfully:', data);

                // Update stats with safe access
                const stats = data.stats || {};
                document.getElementById('totalPosts').textContent = stats.total || 0;
                document.getElementById('pendingModeration').textContent = stats.pending || 0;
                document.getElementById('approvedToday').textContent = stats.approved_today || 0;
                document.getElementById('postedToday').textContent = stats.posted_today || 0;

                // Update recent activity
                allMessages = data.messages || [];
                renderRecentActivity();

                console.log('Dashboard updated successfully');
            } catch (error) {
                console.error('Dashboard loading error:', error);
                // Don't show error notification to avoid spam, just log it
            }
        }

        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');

            if (!allMessages.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nessun messaggio</h3>
                        <p>Non ci sono messaggi da mostrare al momento.</p>
                    </div>
                `;
                return;
            }

            const recentMessages = allMessages.slice(0, 10);
            const html = recentMessages.map(msg => `
                <div class="message-card">
                    <div class="message-header">
                        <span class="message-id">#${msg.id}</span>
                        <span class="message-status status-${msg.status.toLowerCase()}">${msg.status}</span>
                    </div>
                    <div class="message-content">${escapeHtml(msg.text)}</div>
                    <div class="message-meta">
                        <span>${new Date(msg.created_at).toLocaleDateString('it-IT')} ${new Date(msg.created_at).toLocaleTimeString('it-IT')}</span>
                        <span>${msg.status === 'APPROVED' ? 'Approvato' : msg.status === 'REJECTED' ? 'Rifiutato' : 'In Attesa'}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Messages management
        async function loadMessages() {
            try {
                const response = await apiCall('/admin/api/dashboard-data?t=' + Date.now());
                const data = await response.json();

                allMessages = data.messages || [];
                renderMessages();

                showNotification('Messaggi caricati', `${allMessages.length} messaggi trovati`, 'success');
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Errore</h3><p>Impossibile caricare i messaggi</p></div>';
                showNotification('Errore', 'Impossibile caricare i messaggi', 'error');
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesList');
            const filteredMessages = allMessages.filter(msg => {
                if (currentFilter === 'all') return true;
                return msg.status.toLowerCase() === currentFilter;
            });

            if (!filteredMessages.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>Nessun messaggio</h3>
                        <p>${currentFilter === 'all' ? 'Non ci sono messaggi.' : `Nessun messaggio ${currentFilter === 'pending' ? 'in attesa' : currentFilter === 'approved' ? 'approvato' : 'rifiutato'}.`}</p>
                    </div>
                `;
                return;
            }

            const html = filteredMessages.map(msg => `
                <div class="message-card">
                    <div class="message-header">
                        <span class="message-id">#${msg.id}</span>
                        <span class="message-status status-${msg.status.toLowerCase()}">${msg.status}</span>
                    </div>
                    <div class="message-content">${escapeHtml(msg.text)}</div>
                    <div class="message-meta">
                        <span>${new Date(msg.created_at).toLocaleDateString('it-IT')} ${new Date(msg.created_at).toLocaleTimeString('it-IT')}</span>
                        <span>IP: ${msg.ip_address || 'N/A'}</span>
                    </div>
                    <div class="message-actions">
                        ${msg.status === 'PENDING' ? `
                            <button class="btn btn-success btn-sm" onclick="moderateMessage(${msg.id}, 'APPROVED')">
                                <i class="fas fa-check"></i>
                                Approva
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="moderateMessage(${msg.id}, 'REJECTED')">
                                <i class="fas fa-times"></i>
                                Rifiuta
                            </button>
                        ` : msg.status === 'APPROVED' ? `
                            <button class="btn btn-primary btn-sm" onclick="postMessage(${msg.id})">
                                <i class="fas fa-paper-plane"></i>
                                Pubblica
                            </button>
                        ` : ''}
                        <button class="btn btn-outline btn-sm" onclick="viewMessageDetails(${msg.id})">
                            <i class="fas fa-eye"></i>
                            Dettagli
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function filterMessages(filter) {
            currentFilter = filter;
            renderMessages();

            // Update filter buttons
            document.querySelectorAll('.action-buttons button').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(filter === 'all' ? 'tutti' : filter === 'pending' ? 'attesa' : filter === 'approved' ? 'approvati' : 'rifiutati')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        async function moderateMessage(id, action) {
            try {
                const endpoint = action === 'APPROVED' ? `/admin/messages/${id}/approve` : `/admin/messages/${id}/reject`;
                const response = await apiCall(endpoint, { method: 'POST' });

                if (response.ok) {
                    showNotification('Successo', `Messaggio ${action === 'APPROVED' ? 'approvato' : 'rifiutato'} con successo`, 'success');
                    loadMessages();
                    loadDashboardData();
                } else {
                    throw new Error('Moderation failed');
                }
            } catch (error) {
                console.error('Error moderating message:', error);
                showNotification('Errore', 'Impossibile moderare il messaggio', 'error');
            }
        }

        async function postMessage(id) {
            try {
                const response = await apiCall(`/admin/messages/${id}/post`, { method: 'POST' });

                if (response.ok) {
                    showNotification('Successo', 'Messaggio pubblicato su Instagram!', 'success');
                    loadMessages();
                    loadDashboardData();
                } else {
                    throw new Error('Posting failed');
                }
            } catch (error) {
                console.error('Error posting message:', error);
                showNotification('Errore', 'Impossibile pubblicare il messaggio', 'error');
            }
        }

        async function bulkApprove() {
            const pendingMessages = allMessages.filter(msg => msg.status === 'PENDING');
            if (!pendingMessages.length) {
                showNotification('Info', 'Nessun messaggio in attesa', 'warning');
                return;
            }

            if (!confirm(`Approvare tutti i ${pendingMessages.length} messaggi in attesa?`)) return;

            try {
                for (const msg of pendingMessages) {
                    await apiCall(`/admin/messages/${msg.id}/approve`, { method: 'POST' });
                }
                showNotification('Successo', `Approvati ${pendingMessages.length} messaggi`, 'success');
                loadMessages();
                loadDashboardData();
            } catch (error) {
                console.error('Error bulk approving:', error);
                showNotification('Errore', 'Errore durante l\'approvazione bulk', 'error');
            }
        }

        async function bulkReject() {
            const pendingMessages = allMessages.filter(msg => msg.status === 'PENDING');
            if (!pendingMessages.length) {
                showNotification('Info', 'Nessun messaggio in attesa', 'warning');
                return;
            }

            if (!confirm(`Rifiutare tutti i ${pendingMessages.length} messaggi in attesa?`)) return;

            try {
                for (const msg of pendingMessages) {
                    await apiCall(`/admin/messages/${msg.id}/reject`, { method: 'POST' });
                }
                showNotification('Successo', `Rifiutati ${pendingMessages.length} messaggi`, 'success');
                loadMessages();
                loadDashboardData();
            } catch (error) {
                console.error('Error bulk rejecting:', error);
                showNotification('Errore', 'Errore durante il rifiuto bulk', 'error');
            }
        }

        // Daily Post functions
        async function loadDailyPostSettings() {
            try {
                const response = await apiCall('/admin/api/daily-post/settings');
                const settings = await response.json();

                document.getElementById('dailyPostEnabled').checked = settings.enabled || false;
                document.getElementById('dailyPostTime').value = settings.post_time || '16:27';
                document.getElementById('maxMessages').value = settings.max_messages || 10;
                document.getElementById('titleTemplate').value = settings.title_template || 'Post della giornata #{date}';

                // Load stats
                loadDailyPostStats();
            } catch (error) {
                console.error('Error loading daily post settings:', error);
                showNotification('Errore', 'Impossibile caricare le impostazioni', 'error');
            }
        }

        async function loadDailyPostStats() {
            try {
                const response = await apiCall('/admin/api/daily-post/stats');
                const stats = await response.json();

                document.getElementById('dailyPostStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                        <div>
                            <strong>Post Generati:</strong> ${stats.total_posts || 0}
                        </div>
                        <div>
                            <strong>Ultimo Post:</strong> ${stats.last_post ? new Date(stats.last_post).toLocaleDateString('it-IT') : 'Mai'}
                        </div>
                        <div>
                            <strong>Prossimo Post:</strong> ${stats.next_post ? new Date(stats.next_post).toLocaleDateString('it-IT') : 'N/A'}
                        </div>
                        <div>
                            <strong>Status:</strong>
                            <span style="color: ${stats.enabled ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ${stats.enabled ? 'Abilitato' : 'Disabilitato'}
                            </span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('dailyPostStats').innerHTML = '<div style="color: var(--error);">Errore caricamento statistiche</div>';
            }
        }

        async function updateDailyPostSetting(setting, value) {
            try {
                const response = await apiCall('/admin/api/daily-post/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        [setting]: value
                    })
                });

                if (response.ok) {
                    showNotification('Successo', 'Impostazione aggiornata', 'success');
                    loadDailyPostSettings();
                }
            } catch (error) {
                console.error('Error updating setting:', error);
                showNotification('Errore', 'Impossibile aggiornare l\'impostazione', 'error');
            }
        }

        async function testDailyPost() {
            try {
                const response = await apiCall('/admin/api/daily-post/test', { method: 'POST' });
                if (response.ok) {
                    showNotification('Successo', 'Test Daily Post completato!', 'success');
                }
            } catch (error) {
                console.error('Error testing daily post:', error);
                showNotification('Errore', 'Errore durante il test', 'error');
            }
        }

        async function generateDailyPostNow() {
            if (!confirm('Generare il Daily Post ora?')) return;

            try {
                const response = await apiCall('/admin/publish-summary', { method: 'POST' });
                if (response.ok) {
                    showNotification('Successo', 'Daily Post generato e pubblicato!', 'success');
                    loadDailyPostStats();
                }
            } catch (error) {
                console.error('Error generating daily post:', error);
                showNotification('Errore', 'Errore generazione Daily Post', 'error');
            }
        }

        // Info Cards functions
        async function loadInfoCards() {
            try {
                const response = await apiCall('/admin/api/info-cards');
                const cards = await response.json();

                renderInfoCards(cards);
            } catch (error) {
                console.error('Error loading info cards:', error);
                document.getElementById('infoCardsList').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Errore</h3><p>Impossibile caricare le cards</p></div>';
            }
        }

        function renderInfoCards(cards) {
            const container = document.getElementById('infoCardsList');

            if (!cards.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-id-card"></i>
                        <h3>Nessuna Card</h3>
                        <p>Crea la tua prima Info Card per iniziare.</p>
                        <button class="btn btn-primary" onclick="showCreateCardForm()">
                            <i class="fas fa-plus"></i>
                            Crea Card
                        </button>
                    </div>
                `;
                return;
            }

            const html = cards.map(card => `
                <div class="message-card">
                    <div class="message-header">
                        <span class="message-id">#${card.id}</span>
                        <span class="message-status status-posted">ATTIVA</span>
                    </div>
                    <div class="message-content">
                        <strong>${escapeHtml(card.title)}</strong><br>
                        ${escapeHtml(card.text)}
                    </div>
                    <div class="message-meta">
                        <span>${new Date(card.created_at).toLocaleDateString('it-IT')}</span>
                        <span>${card.publish_count || 0} pubblicazioni</span>
                    </div>
                    <div class="message-actions">
                        <button class="btn btn-primary btn-sm" onclick="publishInfoCard(${card.id})">
                            <i class="fas fa-paper-plane"></i>
                            Pubblica
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInfoCard(${card.id})">
                            <i class="fas fa-trash"></i>
                            Elimina
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function showCreateCardForm() {
            document.getElementById('createCardForm').style.display = 'block';
            document.getElementById('cardTitle').focus();

            // Add input listeners for live preview
            document.getElementById('cardTitle').addEventListener('input', updateCardPreview);
            document.getElementById('cardContent').addEventListener('input', updateCardPreview);
        }

        function hideCreateCardForm() {
            document.getElementById('createCardForm').style.display = 'none';
            document.getElementById('cardTitle').value = '';
            document.getElementById('cardContent').value = '';
            updateCardPreview();
        }

        function updateCardPreview() {
            const title = document.getElementById('cardTitle').value.trim();
            const content = document.getElementById('cardContent').value.trim();

            // Show loading state
            document.getElementById('cardPreview').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Generando anteprima...</div>
                </div>
            `;

            // Debounce preview generation
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(() => {
                generateCardPreview(title, content);
            }, 500); // Wait 500ms after user stops typing
        }

        async function generateCardPreview(title, content) {
            if (!title && !content) {
                document.getElementById('cardPreview').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-edit fa-2x" style="margin-bottom: 10px;"></i>
                        <div>Inserisci titolo e contenuto per vedere l'anteprima</div>
                    </div>
                `;
                return;
            }

            try {
                console.log('Generating card preview for:', { title, content });

                // Use the same API endpoint that creates the actual published image
                const response = await fetch('/admin/api/info-cards/preview', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        title: title || '',
                        text: content || ''
                    })
                });

                if (response.status === 401) {
                    document.getElementById('cardPreview').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--error);">
                            <i class="fas fa-lock fa-2x" style="margin-bottom: 10px;"></i>
                            <div>Sessione scaduta. Ricarica la pagina.</div>
                        </div>
                    `;
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('Preview generated:', data);

                if (data.image_url) {
                    // Show the actual generated image (same as published)
                    document.getElementById('cardPreview').innerHTML = `
                        <img src="${data.image_url}?t=${Date.now()}"
                             alt="Card Preview"
                             style="width: 100%; max-width: 300px; border-radius: 12px; box-shadow: var(--shadow-lg); display: block; margin: 0 auto;"
                             onload="console.log('Preview image loaded')"
                             onerror="console.error('Preview image failed to load')">
                    `;
                } else {
                    throw new Error('No image URL returned');
                }

            } catch (error) {
                console.error('Error generating card preview:', error);

                // Fallback: show text preview with error indication
                document.getElementById('cardPreview').innerHTML = `
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 2rem; margin-bottom: 10px;"></i>
                        <div style="font-weight: bold; margin-bottom: 10px; color: var(--warning);">Anteprima non disponibile</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;">
                            L'immagine verrà generata correttamente quando pubblichi la card
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: var(--radius); text-align: left;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: var(--text-primary);">${escapeHtml(title || 'Titolo Card')}</div>
                            <div style="color: var(--text-secondary); line-height: 1.4;">${escapeHtml(content || 'Contenuto della card apparirà qui...')}</div>
                        </div>
                    </div>
                `;
            }
        }

        async function createInfoCard() {
            const title = document.getElementById('cardTitle').value.trim();
            const content = document.getElementById('cardContent').value.trim();

            if (!title || !content) {
                showNotification('Errore', 'Titolo e contenuto sono obbligatori', 'error');
                return;
            }

            try {
                showNotification('Info', 'Creando la card...', 'info');

                const formData = new FormData();
                formData.append('title', title);
                formData.append('text', content);

                const response = await fetch('/admin/api/info-cards', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                if (response.status === 401) {
                    window.location.href = '/admin/login';
                    return;
                }

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Successo', 'Card creata con successo!', 'success');
                    hideCreateCardForm();
                    loadInfoCards();
                } else {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
            } catch (error) {
                console.error('Error creating card:', error);
                showNotification('Errore', 'Impossibile creare la card: ' + error.message, 'error');
            }
        }

        async function publishInfoCard(id) {
            if (!confirm('Pubblicare questa card su Instagram? Verrà generata un\'immagine identica all\'anteprima.')) return;

            try {
                showNotification('Info', 'Pubblicando la card su Instagram...', 'info');

                const response = await fetch(`/admin/api/info-cards/${id}/publish`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.status === 401) {
                    window.location.href = '/admin/login';
                    return;
                }

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Successo', 'Card pubblicata su Instagram!', 'success');
                        loadInfoCards();
                        loadSystemSettings(); // Refresh Instagram stats
                    } else {
                        throw new Error(result.message || 'Pubblicazione fallita');
                    }
                } else {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
            } catch (error) {
                console.error('Error publishing card:', error);
                showNotification('Errore', 'Impossibile pubblicare la card: ' + error.message, 'error');
            }
        }

        async function deleteInfoCard(id) {
            if (!confirm('Eliminare questa card?')) return;

            try {
                const response = await apiCall(`/admin/api/info-cards/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Successo', 'Card eliminata', 'success');
                    loadInfoCards();
                } else {
                    throw new Error('Deletion failed');
                }
            } catch (error) {
                console.error('Error deleting card:', error);
                showNotification('Errore', 'Impossibile eliminare la card', 'error');
            }
        }

        // Settings functions
        async function loadSystemSettings() {
            try {
                // Load Instagram settings
                const igResponse = await fetch('/admin/api/settings/instagram', {
                    credentials: 'same-origin'
                });

                if (igResponse.ok) {
                    const igData = await igResponse.json();
                    document.getElementById('instagramSettings').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                            <div>
                                <strong>Status:</strong>
                                <span style="color: ${igData.connected ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                    ${igData.connected ? 'Connesso' : 'Non Connesso'}
                                </span>
                            </div>
                            <div>
                                <strong>Username:</strong> ${igData.username || 'N/A'}
                            </div>
                            <div>
                                <strong>Ultima Pubblicazione:</strong> ${igData.last_post ? new Date(igData.last_post).toLocaleString('it-IT') : 'Mai'}
                            </div>
                            <div>
                                <strong>Stories Pubblicati:</strong> ${igData.stories_count || 0}
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('instagramSettings').innerHTML = `
                        <div style="text-align: center; color: var(--error);">
                            <i class="fas fa-exclamation-triangle"></i>
                            Errore caricamento impostazioni Instagram
                        </div>
                    `;
                }

                // Load Gemini settings
                const geminiResponse = await fetch('/admin/api/settings/gemini', {
                    credentials: 'same-origin'
                });

                if (geminiResponse.ok) {
                    const geminiData = await geminiResponse.json();
                    document.getElementById('geminiSettings').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                            <div>
                                <strong>Status:</strong>
                                <span style="color: ${geminiData.configured ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                    ${geminiData.configured ? 'Configurato' : 'Non Configurato'}
                                </span>
                            </div>
                            <div>
                                <strong>Modello:</strong> ${geminiData.model || 'N/A'}
                            </div>
                            <div>
                                <strong>Messaggi Moderati:</strong> ${geminiData.moderated_count || 0}
                            </div>
                            <div>
                                <strong>Quota Utilizzata:</strong> ${geminiData.quota_used || 0}%
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('geminiSettings').innerHTML = `
                        <div style="text-align: center; color: var(--error);">
                            <i class="fas fa-exclamation-triangle"></i>
                            Errore caricamento impostazioni AI
                        </div>
                    `;
                }

                // Load System settings
                loadSystemInfo();

            } catch (error) {
                console.error('Error loading system settings:', error);
            }
        }

        async function loadSystemInfo() {
            try {
                const response = await fetch('/admin/api/debug', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('systemSettings').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                            <div>
                                <strong>Version:</strong> ${data.version || '1.0.0'}
                            </div>
                            <div>
                                <strong>Status:</strong>
                                <span style="color: var(--success); font-weight: 600;">
                                    <i class="fas fa-circle" style="margin-right: var(--space-xs);"></i>
                                    Online
                                </span>
                            </div>
                            <div>
                                <strong>Python:</strong> ${data.python_version || '3.11'}
                            </div>
                            <div>
                                <strong>Database:</strong>
                                <span style="color: var(--success); font-weight: 600;">
                                    <i class="fas fa-check-circle" style="margin-right: var(--space-xs);"></i>
                                    Connected
                                </span>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('systemSettings').innerHTML = `
                        <div style="text-align: center; color: var(--error);">
                            <i class="fas fa-exclamation-triangle"></i>
                            Errore caricamento info sistema
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading system info:', error);
                document.getElementById('systemSettings').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Errore caricamento info sistema
                    </div>
                `;
            }
        }

        // Instagram Settings Management
        function showInstagramSettings() {
            document.getElementById('instagramSettingsForm').style.display = 'block';
            // Pre-fill with current values if available
        }

        function hideInstagramSettings() {
            document.getElementById('instagramSettingsForm').style.display = 'none';
        }

        async function saveInstagramSettings() {
            const username = document.getElementById('instagramUsername').value.trim();
            const password = document.getElementById('instagramPassword').value;

            if (!username || !password) {
                showNotification('Errore', 'Username e password sono obbligatori', 'error');
                return;
            }

            try {
                const response = await fetch('/admin/api/settings/instagram', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        username: username,
                        password: password
                    })
                });

                if (response.ok) {
                    showNotification('Successo', 'Impostazioni Instagram salvate', 'success');
                    hideInstagramSettings();
                    loadSystemSettings();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving Instagram settings:', error);
                showNotification('Errore', 'Impossibile salvare le impostazioni Instagram', 'error');
            }
        }

        async function testInstagramConnection() {
            try {
                showNotification('Info', 'Testando connessione Instagram...', 'info');
                const response = await fetch('/admin/api/settings/instagram/test', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Successo', 'Connessione Instagram riuscita!', 'success');
                    } else {
                        showNotification('Errore', 'Connessione Instagram fallita: ' + result.message, 'error');
                    }
                } else {
                    throw new Error('Test failed');
                }
            } catch (error) {
                console.error('Error testing Instagram:', error);
                showNotification('Errore', 'Errore durante il test della connessione', 'error');
            }
        }

        // AI Settings Management
        function showAISettings() {
            document.getElementById('geminiSettingsForm').style.display = 'block';
        }

        function hideAISettings() {
            document.getElementById('geminiSettingsForm').style.display = 'none';
        }

        async function saveAISettings() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const enabled = document.getElementById('aiModerationEnabled').checked;
            const model = document.getElementById('aiModel').value;

            try {
                const response = await fetch('/admin/api/settings/gemini', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        api_key: apiKey,
                        enabled: enabled,
                        model: model
                    })
                });

                if (response.ok) {
                    showNotification('Successo', 'Impostazioni AI salvate', 'success');
                    hideAISettings();
                    loadSystemSettings();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving AI settings:', error);
                showNotification('Errore', 'Impossibile salvare le impostazioni AI', 'error');
            }
        }

        async function testAIConnection() {
            try {
                showNotification('Info', 'Testando connessione AI...', 'info');
                const response = await fetch('/admin/api/settings/gemini/test', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Successo', 'Connessione AI riuscita!', 'success');
                    } else {
                        showNotification('Errore', 'Connessione AI fallita: ' + result.message, 'error');
                    }
                } else {
                    throw new Error('Test failed');
                }
            } catch (error) {
                console.error('Error testing AI:', error);
                showNotification('Errore', 'Errore durante il test della connessione AI', 'error');
            }
        }

        function toggleAIModeration(enabled) {
            console.log('AI Moderation toggled:', enabled);
        }

        // System Settings Management
        function showSystemSettings() {
            document.getElementById('systemSettingsForm').style.display = 'block';
        }

        function hideSystemSettings() {
            document.getElementById('systemSettingsForm').style.display = 'none';
        }

        async function saveSystemSettings() {
            const maintenanceMode = document.getElementById('maintenanceMode').checked;
            const maxMessagesPerHour = document.getElementById('maxMessagesPerHour').value;
            const sessionTimeout = document.getElementById('sessionTimeout').value;

            try {
                const response = await fetch('/admin/api/settings/system', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        maintenance_mode: maintenanceMode,
                        max_messages_per_hour: maxMessagesPerHour,
                        session_timeout: sessionTimeout
                    })
                });

                if (response.ok) {
                    showNotification('Successo', 'Impostazioni sistema salvate', 'success');
                    hideSystemSettings();
                    loadSystemInfo();
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving system settings:', error);
                showNotification('Errore', 'Impossibile salvare le impostazioni sistema', 'error');
            }
        }

        async function resetSystemSettings() {
            if (!confirm('Resettare tutte le impostazioni sistema ai valori default?')) return;

            try {
                const response = await fetch('/admin/api/settings/system/reset', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Impostazioni sistema resettate', 'success');
                    hideSystemSettings();
                    loadSystemInfo();
                } else {
                    throw new Error('Reset failed');
                }
            } catch (error) {
                console.error('Error resetting system settings:', error);
                showNotification('Errore', 'Impossibile resettare le impostazioni', 'error');
            }
        }

        async function restartApplication() {
            if (!confirm('Riavviare l\'applicazione? Tutti gli utenti connessi verranno disconnessi.')) return;

            try {
                showNotification('Info', 'Riavvio applicazione in corso...', 'info');
                const response = await fetch('/admin/api/system/restart', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Applicazione riavviata! Ricarica la pagina.', 'success');
                    setTimeout(() => window.location.reload(), 3000);
                } else {
                    throw new Error('Restart failed');
                }
            } catch (error) {
                console.error('Error restarting application:', error);
                showNotification('Errore', 'Impossibile riavviare l\'applicazione', 'error');
            }
        }

        async function clearCache() {
            if (!confirm('Svuotare la cache? Questa azione è irreversibile.')) return;

            try {
                showNotification('Info', 'Svuotamento cache in corso...', 'info');
                const response = await fetch('/admin/api/system/clear-cache', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Cache svuotata con successo', 'success');
                    loadSystemInfo();
                } else {
                    throw new Error('Clear cache failed');
                }
            } catch (error) {
                console.error('Error clearing cache:', error);
                showNotification('Errore', 'Impossibile svuotare la cache', 'error');
            }
        }

        function toggleMaintenanceMode(enabled) {
            console.log('Maintenance mode toggled:', enabled);
            if (enabled) {
                showNotification('Attenzione', 'Modalità manutenzione abilitata. Il sito potrebbe non essere accessibile.', 'warning');
            }
        }

        // Advanced Management Functions

        function showDangerZone() {
            const dangerZone = document.getElementById('dangerZone');
            const backupManager = document.getElementById('backupManager');
            const systemLogs = document.getElementById('systemLogs');

            // Hide others
            backupManager.style.display = 'none';
            systemLogs.style.display = 'none';

            // Toggle danger zone
            dangerZone.style.display = dangerZone.style.display === 'none' ? 'block' : 'none';

            if (dangerZone.style.display === 'block') {
                showNotification('Attenzione', 'Sei entrato nella Zona Pericolo. Procedi con estrema cautela!', 'warning');
            }
        }

        function showBackupManager() {
            const dangerZone = document.getElementById('dangerZone');
            const backupManager = document.getElementById('backupManager');
            const systemLogs = document.getElementById('systemLogs');

            // Hide others
            dangerZone.style.display = 'none';
            systemLogs.style.display = 'none';

            // Show backup manager
            backupManager.style.display = backupManager.style.display === 'none' ? 'block' : 'none';

            if (backupManager.style.display === 'block') {
                loadBackupStatus();
            }
        }

        function showSystemLogs() {
            const dangerZone = document.getElementById('dangerZone');
            const backupManager = document.getElementById('backupManager');
            const systemLogs = document.getElementById('systemLogs');

            // Hide others
            dangerZone.style.display = 'none';
            backupManager.style.display = 'none';

            // Show system logs
            systemLogs.style.display = systemLogs.style.display === 'none' ? 'block' : 'none';

            if (systemLogs.style.display === 'block') {
                loadSystemLogs();
            }
        }

        // Danger Zone Functions
        async function deleteMessagesByStatus(status) {
            const statusText = status === 'PENDING' ? 'in attesa' : status === 'APPROVED' ? 'approvati' : 'rifiutati';
            const count = allMessages.filter(msg => msg.status === status).length;

            if (count === 0) {
                showNotification('Info', `Nessun messaggio ${statusText} da cancellare`, 'info');
                return;
            }

            const confirmText = `Sei SICURO di voler cancellare tutti i ${count} messaggi ${statusText}?\n\nQuesta azione è IRREVERSIBILE!`;
            if (!confirm(confirmText)) return;

            const doubleConfirm = `CONFERMA FINALE: Digita "CANCELLA" per procedere:`;
            const userInput = prompt(doubleConfirm);
            if (userInput !== 'CANCELLA') {
                showNotification('Annullato', 'Operazione annullata', 'info');
                return;
            }

            try {
                showNotification('Avviso', 'Creando backup automatico prima della cancellazione...', 'warning');

                // Create automatic backup
                await createAutomaticBackup();

                showNotification('Info', 'Cancellando messaggi...', 'info');

                const response = await fetch('/admin/api/messages/delete-by-status', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Successo', `Cancellati ${result.deleted_count} messaggi ${statusText}`, 'success');
                    loadDashboardData();
                    loadMessages();
                } else {
                    throw new Error('Cancellazione fallita');
                }
            } catch (error) {
                console.error('Error deleting messages:', error);
                showNotification('Errore', 'Impossibile cancellare i messaggi', 'error');
            }
        }

        async function deleteAllMessages() {
            const totalCount = allMessages.length;

            if (totalCount === 0) {
                showNotification('Info', 'Nessun messaggio da cancellare', 'info');
                return;
            }

            const confirmText = `🚨 OPERAZIONE CRITICA 🚨\n\nSei SICURO di voler cancellare TUTTI i ${totalCount} messaggi?\n\nQuesta azione è IRREVERSIBILE e cancellerà tutti i messaggi dal database!`;
            if (!confirm(confirmText)) return;

            const doubleConfirm = `CONFERMA FINALE: Digita "CANCELLA TUTTO" per procedere:`;
            const userInput = prompt(doubleConfirm);
            if (userInput !== 'CANCELLA TUTTO') {
                showNotification('Annullato', 'Operazione annullata', 'info');
                return;
            }

            const tripleConfirm = `ULTIMA CONFERMA: Questa è la tua ultima possibilità.\nDigita il numero totale di messaggi (${totalCount}) per confermare:`;
            const countInput = prompt(tripleConfirm);
            if (countInput !== totalCount.toString()) {
                showNotification('Annullato', 'Operazione annullata - numero non corretto', 'info');
                return;
            }

            try {
                showNotification('Avviso', 'Creando backup completo prima della cancellazione totale...', 'warning');

                // Create full backup
                await createFullBackup();

                showNotification('Info', 'Cancellando tutti i messaggi...', 'info');

                const response = await fetch('/admin/api/messages/delete-all', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Tutti i messaggi sono stati cancellati', 'success');
                    loadDashboardData();
                    loadMessages();
                } else {
                    throw new Error('Cancellazione totale fallita');
                }
            } catch (error) {
                console.error('Error deleting all messages:', error);
                showNotification('Errore', 'Impossibile cancellare tutti i messaggi', 'error');
            }
        }

        async function deleteAllInfoCards() {
            if (!confirm('Cancellare tutte le Info Cards? Questa azione è irreversibile!')) return;

            try {
                showNotification('Avviso', 'Creando backup prima della cancellazione...', 'warning');
                await createAutomaticBackup();

                const response = await fetch('/admin/api/info-cards/delete-all', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Tutte le Info Cards cancellate', 'success');
                    loadInfoCards();
                } else {
                    throw new Error('Cancellazione fallita');
                }
            } catch (error) {
                console.error('Error deleting info cards:', error);
                showNotification('Errore', 'Impossibile cancellare le Info Cards', 'error');
            }
        }

        async function deleteAllDailyPosts() {
            if (!confirm('Cancellare tutti i Daily Posts? Questa azione è irreversibile!')) return;

            try {
                await createAutomaticBackup();

                const response = await fetch('/admin/api/daily-posts/delete-all', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Tutti i Daily Posts cancellati', 'success');
                    loadDailyPostSettings();
                } else {
                    throw new Error('Cancellazione fallita');
                }
            } catch (error) {
                console.error('Error deleting daily posts:', error);
                showNotification('Errore', 'Impossibile cancellare i Daily Posts', 'error');
            }
        }

        async function resetAllSettings() {
            if (!confirm('Resettare TUTTE le impostazioni ai valori default?')) return;

            try {
                await createAutomaticBackup();

                const response = await fetch('/admin/api/settings/reset-all', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Tutte le impostazioni resettate', 'success');
                    loadSystemSettings();
                } else {
                    throw new Error('Reset fallito');
                }
            } catch (error) {
                console.error('Error resetting settings:', error);
                showNotification('Errore', 'Impossibile resettare le impostazioni', 'error');
            }
        }

        async function nuclearOption() {
            const confirmText = `🚨 🚨 🚨 NUCLEAR OPTION 🚨 🚨 🚨\n\nQuesta è l'opzione più distruttiva possibile!\n\nCancellerà:\n• TUTTI i messaggi\n• TUTTE le Info Cards\n• TUTTI i Daily Posts\n• TUTTE le impostazioni\n• TUTTI i dati del database\n\nIL DATABASE SARÀ COMPLETAMENTE VUOTO!\n\nSei ASSOLUTAMENTE SICURO?`;

            if (!confirm(confirmText)) return;

            const doubleConfirm = `CONFERMA NUCLEARE: Digita "NUCLEARE" per procedere:`;
            const userInput = prompt(doubleConfirm);
            if (userInput !== 'NUCLEARE') {
                showNotification('Annullato', 'Opzione nucleare annullata', 'info');
                return;
            }

            const tripleConfirm = `ULTIMA CONFERMA NUCLEARE:\n\nScrivi "CONFERMO LA DISTRUZIONE TOTALE" (tutto maiuscolo):`;
            const finalInput = prompt(tripleConfirm);
            if (finalInput !== 'CONFERMO LA DISTRUZIONE TOTALE') {
                showNotification('Annullato', 'Opzione nucleare annullata', 'info');
                return;
            }

            try {
                showNotification('Avviso', 'Creando backup finale prima della distruzione totale...', 'error');

                // Create final backup
                await createFullBackup();

                showNotification('Info', 'Avviando distruzione totale...', 'error');

                const response = await fetch('/admin/api/system/nuclear-option', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Completato', 'Distruzione totale completata. Il sistema è stato resettato.', 'success');
                    setTimeout(() => window.location.reload(), 3000);
                } else {
                    throw new Error('Nuclear option failed');
                }
            } catch (error) {
                console.error('Error nuclear option:', error);
                showNotification('Errore', 'Opzione nucleare fallita', 'error');
            }
        }

        // Backup Functions
        async function loadBackupStatus() {
            try {
                const response = await fetch('/admin/api/backup/status', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const status = await response.json();
                    document.getElementById('backupStatus').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                            <div>
                                <strong>Ultimo Backup:</strong> ${status.last_backup ? new Date(status.last_backup).toLocaleString('it-IT') : 'Mai'}
                            </div>
                            <div>
                                <strong>Backup Automatici:</strong> ${status.auto_backup_enabled ? 'Abilitati' : 'Disabilitati'}
                            </div>
                            <div>
                                <strong>Dimensione Backup:</strong> ${status.total_size || 'N/A'}
                            </div>
                            <div>
                                <strong>Backup Disponibili:</strong> ${status.backup_count || 0}
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('backupStatus').innerHTML = `
                        <div style="text-align: center; color: var(--error);">
                            Errore caricamento stato backup
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading backup status:', error);
                document.getElementById('backupStatus').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        Errore caricamento stato backup
                    </div>
                `;
            }
        }

        async function createFullBackup() {
            try {
                showNotification('Info', 'Creando backup completo...', 'info');

                const response = await fetch('/admin/api/backup/create-full', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Successo', `Backup creato: ${result.filename}`, 'success');
                    loadBackupStatus();
                    return result;
                } else {
                    throw new Error('Backup creation failed');
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                showNotification('Errore', 'Impossibile creare il backup', 'error');
                throw error;
            }
        }

        async function createAutomaticBackup() {
            try {
                const response = await fetch('/admin/api/backup/create-auto', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    console.log('Automatic backup created');
                }
            } catch (error) {
                console.error('Error creating automatic backup:', error);
            }
        }

        async function createManualBackup() {
            await createFullBackup();
        }

        async function viewBackups() {
            try {
                const response = await fetch('/admin/api/backup/list', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const backups = await response.json();

                    let html = '<h5 style="margin-bottom: var(--space-lg);">Backup Disponibili</h5>';

                    if (backups.length === 0) {
                        html += '<div style="text-align: center; color: var(--text-muted);">Nessun backup disponibile</div>';
                    } else {
                        backups.forEach(backup => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <div style="font-weight: 600;">${backup.filename}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            ${new Date(backup.created_at).toLocaleString('it-IT')} - ${backup.size}
                                        </div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn btn-success btn-sm" onclick="downloadSpecificBackup('${backup.filename}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.filename}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // Show in modal
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Gestione Backup</h3>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                ${html}
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading backups:', error);
                showNotification('Errore', 'Impossibile caricare la lista backup', 'error');
            }
        }

        async function downloadBackup() {
            try {
                const response = await fetch('/admin/api/backup/download-latest', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `insta_spotter_backup_${new Date().toISOString().split('T')[0]}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showNotification('Successo', 'Backup scaricato', 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Error downloading backup:', error);
                showNotification('Errore', 'Impossibile scaricare il backup', 'error');
            }
        }

        async function downloadSpecificBackup(filename) {
            try {
                const response = await fetch(`/admin/api/backup/download/${filename}`, {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showNotification('Successo', `Backup ${filename} scaricato`, 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Error downloading backup:', error);
                showNotification('Errore', 'Impossibile scaricare il backup', 'error');
            }
        }

        async function deleteBackup(filename) {
            if (!confirm(`Cancellare il backup ${filename}?`)) return;

            try {
                const response = await fetch(`/admin/api/backup/delete/${filename}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Backup cancellato', 'success');
                    loadBackupStatus();
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                console.error('Error deleting backup:', error);
                showNotification('Errore', 'Impossibile cancellare il backup', 'error');
            }
        }

        async function restoreFromBackup() {
            if (!confirm('Questa operazione ripristinerà il database da un backup. I dati attuali verranno persi. Continuare?')) return;

            try {
                const backups = await (await fetch('/admin/api/backup/list', { credentials: 'same-origin' })).json();

                if (backups.length === 0) {
                    showNotification('Errore', 'Nessun backup disponibile', 'error');
                    return;
                }

                // Show backup selection modal
                let options = '<select id="backupSelect" class="form-select" style="margin-bottom: var(--space-lg);">';
                backups.forEach(backup => {
                    options += `<option value="${backup.filename}">${backup.filename} (${new Date(backup.created_at).toLocaleDateString('it-IT')})</option>`;
                });
                options += '</select>';

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Ripristina da Backup</h4>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div style="margin-bottom: var(--space-lg);">
                            <strong style="color: var(--error);">Attenzione:</strong> Questa operazione sovrascriverà tutti i dati attuali.
                        </div>
                        ${options}
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="confirmRestore()">Ripristina</button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Annulla</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Add confirm function to window
                window.confirmRestore = async function() {
                    const filename = document.getElementById('backupSelect').value;

                    modal.remove();

                    showNotification('Info', 'Avviando ripristino...', 'info');

                    try {
                        const response = await fetch('/admin/api/backup/restore', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: filename })
                        });

                        if (response.ok) {
                            showNotification('Successo', 'Ripristino completato. Ricarica la pagina.', 'success');
                            setTimeout(() => window.location.reload(), 3000);
                        } else {
                            throw new Error('Restore failed');
                        }
                    } catch (error) {
                        console.error('Error restoring backup:', error);
                        showNotification('Errore', 'Impossibile ripristinare il backup', 'error');
                    }
                };

                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('Error loading backups for restore:', error);
                showNotification('Errore', 'Impossibile caricare i backup', 'error');
            }
        }

        // System Logs Functions
        async function loadSystemLogs() {
            try {
                const logType = document.getElementById('logType').value;
                const logPeriod = document.getElementById('logPeriod').value;

                const response = await fetch(`/admin/api/logs?type=${logType}&period=${logPeriod}`, {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const logs = await response.json();

                    let html = '';
                    if (logs.length === 0) {
                        html = '<div style="text-align: center; color: var(--text-muted); padding: var(--space-2xl);">Nessun log trovato per i filtri selezionati</div>';
                    } else {
                        logs.forEach(log => {
                            const logClass = log.level.toLowerCase();
                            const logIcon = log.level === 'ERROR' ? 'exclamation-triangle' :
                                          log.level === 'WARNING' ? 'exclamation-circle' :
                                          log.level === 'INFO' ? 'info-circle' : 'check-circle';

                            html += `
                                <div style="display: flex; gap: var(--space-md); padding: var(--space-md); border-bottom: 1px solid var(--border); align-items: flex-start;">
                                    <div style="flex-shrink: 0;">
                                        <i class="fas fa-${logIcon} log-${logClass}" style="color: var(--${logClass === 'error' ? 'error' : logClass === 'warning' ? 'warning' : 'info'});"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: var(--space-xs);">
                                            ${log.level} - ${log.category || 'Sistema'}
                                        </div>
                                        <div style="color: var(--text-primary); margin-bottom: var(--space-xs);">
                                            ${escapeHtml(log.message)}
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            ${new Date(log.timestamp).toLocaleString('it-IT')} ${log.user ? `- ${log.user}` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    document.getElementById('logsContainer').innerHTML = html;
                } else {
                    document.getElementById('logsContainer').innerHTML = `
                        <div style="text-align: center; color: var(--error);">
                            Errore caricamento log
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsContainer').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        Errore caricamento log
                    </div>
                `;
            }
        }

        async function exportLogs() {
            try {
                const logType = document.getElementById('logType').value;
                const logPeriod = document.getElementById('logPeriod').value;

                const response = await fetch(`/admin/api/logs/export?type=${logType}&period=${logPeriod}`, {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `system_logs_${logType}_${logPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showNotification('Successo', 'Log esportati', 'success');
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                console.error('Error exporting logs:', error);
                showNotification('Errore', 'Impossibile esportare i log', 'error');
            }
        }

        async function clearOldLogs() {
            if (!confirm('Cancellare i log più vecchi di 30 giorni?')) return;

            try {
                const response = await fetch('/admin/api/logs/clear-old', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Log vecchi cancellati', 'success');
                    loadSystemLogs();
                } else {
                    throw new Error('Clear failed');
                }
            } catch (error) {
                console.error('Error clearing logs:', error);
                showNotification('Errore', 'Impossibile cancellare i log vecchi', 'error');
            }
        }

        // Advanced Data Management
        function showAdvancedDataManagement() {
            // Show advanced search and management modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Gestione Dati Avanzata</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin-bottom: var(--space-xl);">
                        <div class="form-group">
                            <label class="form-label">Ricerca Avanzata</label>
                            <input type="text" id="searchQuery" class="form-input" placeholder="Cerca nei messaggi...">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md);">
                            <select id="searchStatus" class="form-select">
                                <option value="">Tutti gli stati</option>
                                <option value="PENDING">In Attesa</option>
                                <option value="APPROVED">Approvati</option>
                                <option value="REJECTED">Rifiutati</option>
                            </select>
                            <input type="date" id="searchDateFrom" class="form-input">
                            <input type="date" id="searchDateTo" class="form-input">
                        </div>
                        <div class="action-buttons" style="margin-top: var(--space-md);">
                            <button class="btn btn-primary" onclick="performAdvancedSearch()">Cerca</button>
                            <button class="btn btn-success" onclick="exportSearchResults()">Esporta Risultati</button>
                        </div>
                    </div>
                    <div id="searchResults" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showUserManagement() {
            // Show technical users management modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Gestione Utenti Tecnici</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div id="usersContainer" class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Caricamento utenti...</div>
                    </div>
                    <div class="action-buttons" style="margin-top: var(--space-lg);">
                        <button class="btn btn-success" onclick="addTechnicalUser()">Aggiungi Utente</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Load users
            loadTechnicalUsers();

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function loadTechnicalUsers() {
            try {
                const response = await fetch('/admin/api/users/technical', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const users = await response.json();

                    let html = '<h5 style="margin-bottom: var(--space-lg);">Utenti Tecnici</h5>';

                    if (users.length === 0) {
                        html += '<div style="text-align: center; color: var(--text-muted);">Nessun utente tecnico</div>';
                    } else {
                        users.forEach(user => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-md);">
                                    <div>
                                        <div style="font-weight: 600;">${user.username}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            Creato: ${new Date(user.created_at).toLocaleDateString('it-IT')}
                                            ${user.last_login ? ` - Ultimo accesso: ${new Date(user.last_login).toLocaleDateString('it-IT')}` : ''}
                                        </div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" onclick="resetUserPassword('${user.id}')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTechnicalUser('${user.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    document.getElementById('usersContainer').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading technical users:', error);
                document.getElementById('usersContainer').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        Errore caricamento utenti
                    </div>
                `;
            }
        }

        async function addTechnicalUser() {
            const username = prompt('Nome utente per il nuovo utente tecnico:');
            if (!username) return;

            const password = prompt('Password per il nuovo utente:');
            if (!password) return;

            try {
                const response = await fetch('/admin/api/users/technical', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });

                if (response.ok) {
                    showNotification('Successo', 'Utente tecnico creato', 'success');
                    loadTechnicalUsers();
                } else {
                    throw new Error('Creation failed');
                }
            } catch (error) {
                console.error('Error creating technical user:', error);
                showNotification('Errore', 'Impossibile creare l\'utente tecnico', 'error');
            }
        }

        async function deleteTechnicalUser(userId) {
            if (!confirm('Cancellare questo utente tecnico?')) return;

            try {
                const response = await fetch(`/admin/api/users/technical/${userId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Utente tecnico cancellato', 'success');
                    loadTechnicalUsers();
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                console.error('Error deleting technical user:', error);
                showNotification('Errore', 'Impossibile cancellare l\'utente tecnico', 'error');
            }
        }

        async function resetUserPassword(userId) {
            const newPassword = prompt('Nuova password:');
            if (!newPassword) return;

            try {
                const response = await fetch(`/admin/api/users/technical/${userId}/password`, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: newPassword })
                });

                if (response.ok) {
                    showNotification('Successo', 'Password resettata', 'success');
                } else {
                    throw new Error('Reset failed');
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                showNotification('Errore', 'Impossibile resettare la password', 'error');
            }
        }

        async function performAdvancedSearch() {
            const query = document.getElementById('searchQuery').value;
            const status = document.getElementById('searchStatus').value;
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;

            try {
                const params = new URLSearchParams({
                    query: query,
                    status: status,
                    date_from: dateFrom,
                    date_to: dateTo
                });

                const response = await fetch(`/admin/api/messages/search?${params}`, {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const results = await response.json();

                    let html = `<h5>Risultati: ${results.length} messaggi trovati</h5>`;

                    if (results.length === 0) {
                        html += '<div style="text-align: center; color: var(--text-muted); padding: var(--space-xl);">Nessun risultato trovato</div>';
                    } else {
                        results.forEach(msg => {
                            html += `
                                <div class="message-card">
                                    <div class="message-header">
                                        <span class="message-id">#${msg.id}</span>
                                        <span class="message-status status-${msg.status.toLowerCase()}">${msg.status}</span>
                                    </div>
                                    <div class="message-content">${escapeHtml(msg.text)}</div>
                                    <div class="message-meta">
                                        <span>${new Date(msg.created_at).toLocaleString('it-IT')}</span>
                                        <span>IP: ${msg.ip_address || 'N/A'}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    document.getElementById('searchResults').innerHTML = html;
                }
            } catch (error) {
                console.error('Error performing search:', error);
                document.getElementById('searchResults').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        Errore durante la ricerca
                    </div>
                `;
            }
        }

        async function exportSearchResults() {
            // Implement export of search results
            showNotification('Info', 'Funzione export in sviluppo', 'info');
        }

        async function generateAnalyticsReport() {
            try {
                showNotification('Info', 'Generando report analytics...', 'info');

                const response = await fetch('/admin/api/analytics/generate-report', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const result = await response.json();

                    // Download report
                    const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showNotification('Successo', 'Report analytics generato e scaricato', 'success');
                } else {
                    throw new Error('Report generation failed');
                }
            } catch (error) {
                console.error('Error generating analytics report:', error);
                showNotification('Errore', 'Impossibile generare il report analytics', 'error');
            }
        }

        async function exportAnalyticsData() {
            try {
                const response = await fetch('/admin/api/analytics/export', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analytics_data_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showNotification('Successo', 'Dati analytics esportati', 'success');
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                console.error('Error exporting analytics:', error);
                showNotification('Errore', 'Impossibile esportare i dati analytics', 'error');
            }
        }

        async function scheduleAutomaticBackup() {
            // Toggle automatic backup scheduling
            showNotification('Info', 'Funzione backup automatico in sviluppo', 'info');
        }

        // Advanced Authentication Functions

        function showAdvancedAuth() {
            const dangerZone = document.getElementById('dangerZone');
            const backupManager = document.getElementById('backupManager');
            const systemLogs = document.getElementById('systemLogs');
            const advancedAuth = document.getElementById('advancedAuth');

            // Hide others
            dangerZone.style.display = 'none';
            backupManager.style.display = 'none';
            systemLogs.style.display = 'none';

            // Show advanced auth
            advancedAuth.style.display = advancedAuth.style.display === 'none' ? 'block' : 'none';

            if (advancedAuth.style.display === 'block') {
                loadLinkedDevices();
            }
        }

        async function generateQRCode() {
            try {
                showNotification('Info', 'Generando codice QR...', 'info');

                const response = await fetch('/admin/api/auth/generate-qr', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.status === 401) {
                    window.location.href = '/admin/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Show QR code area
                    document.getElementById('qrCodeArea').style.display = 'block';

                    // Generate real QR code
                    const qrContainer = document.getElementById('qrCodeContainer');
                    qrContainer.innerHTML = '<div id="qrcode" style="display: inline-block;"></div>';

                    // Create QR code with the auth URL
                    QRCode.toCanvas(document.getElementById('qrcode'), data.qr_data.url, {
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#FFFFFF",
                        correctLevel: QRCode.CorrectLevel.H
                    }, function (error) {
                        if (error) {
                            console.error('QR Code generation error:', error);
                            qrContainer.innerHTML = `
                                <div style="color: var(--error); text-align: center;">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    <div>Errore generazione QR</div>
                                </div>
                            `;
                        }
                    });

                    // Start countdown
                    let timeLeft = 300;
                    const countdownEl = document.getElementById('qrCountdown');
                    const countdownInterval = setInterval(() => {
                        timeLeft--;
                        countdownEl.textContent = timeLeft;

                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                            document.getElementById('qrCodeArea').style.display = 'none';
                            showNotification('Info', 'QR Code scaduto', 'warning');
                        }
                    }, 1000);

                    showNotification('Success', 'QR Code generato! Scansiona con il cellulare per accedere automaticamente.', 'success');

                } else {
                    throw new Error(data.error || 'Errore generazione QR');
                }

            } catch (error) {
                console.error('Error generating QR:', error);
                showNotification('Errore', 'Impossibile generare il codice QR', 'error');
            }
        }

        async function registerPasskey() {
            try {
                showNotification('Info', 'Iniziando registrazione passkey...', 'info');

                // Check if WebAuthn is supported
                if (!window.PublicKeyCredential) {
                    showNotification('Errore', 'WebAuthn non supportato da questo browser', 'error');
                    return;
                }

                // Start registration
                const response = await fetch('/admin/api/auth/webauthn/register-begin', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.status === 401) {
                    window.location.href = '/admin/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Create credential
                    const publicKeyCredentialCreationOptions = {
                        challenge: Uint8Array.from(atob(data.registration_data.challenge), c => c.charCodeAt(0)),
                        rp: data.registration_data.rp,
                        user: {
                            id: Uint8Array.from(atob(data.registration_data.user.id), c => c.charCodeAt(0)),
                            name: data.registration_data.user.name,
                            displayName: data.registration_data.user.displayName
                        },
                        pubKeyCredParams: data.registration_data.pubKeyCredParams,
                        authenticatorSelection: data.registration_data.authenticatorSelection,
                        attestation: data.registration_data.attestation
                    };

                    const credential = await navigator.credentials.create({
                        publicKey: publicKeyCredentialCreationOptions
                    });

                    // Complete registration
                    const completeResponse = await fetch('/admin/api/auth/webauthn/register-complete', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: credential.id,
                            publicKey: btoa(String.fromCharCode(...new Uint8Array(credential.response.getPublicKey()))),
                            attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject)))
                        })
                    });

                    const completeData = await completeResponse.json();

                    if (completeData.success) {
                        showNotification('Successo', 'Passkey registrata con successo!', 'success');
                        loadLinkedDevices();
                    } else {
                        throw new Error(completeData.error || 'Registrazione fallita');
                    }

                } else {
                    throw new Error(data.error || 'Errore inizio registrazione');
                }

            } catch (error) {
                console.error('Error registering passkey:', error);
                if (error.name === 'NotAllowedError') {
                    showNotification('Errore', 'Registrazione passkey annullata dall\'utente', 'warning');
                } else {
                    showNotification('Errore', 'Impossibile registrare la passkey: ' + error.message, 'error');
                }
            }
        }

        async function loadLinkedDevices() {
            try {
                const response = await fetch('/admin/api/auth/devices', {
                    credentials: 'same-origin'
                });

                if (response.status === 401) {
                    window.location.href = '/admin/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                const container = document.getElementById('devicesList');

                if (data.success && data.devices.length > 0) {
                    let html = '';

                    data.devices.forEach(device => {
                        const deviceIcon = device.type === 'mobile_qr' ? 'mobile-alt' :
                                         device.type === 'passkey' ? 'fingerprint' : 'desktop';
                        const deviceName = device.type === 'mobile_qr' ? 'Mobile (QR)' :
                                         device.type === 'passkey' ? 'Passkey Device' : 'Desktop';

                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-md); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: var(--space-sm);">
                                <div style="display: flex; align-items: center; gap: var(--space-md);">
                                    <i class="fas fa-${deviceIcon}" style="color: var(--primary);"></i>
                                    <div>
                                        <div style="font-weight: 600;">${deviceName}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            Collegato: ${new Date(device.linked_at).toLocaleDateString('it-IT')}
                                            ${device.last_used ? ` - Ultimo uso: ${new Date(device.last_used).toLocaleDateString('it-IT')}` : ''}
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="unlinkDevice('${device.id}')">
                                    <i class="fas fa-unlink"></i>
                                    Scollega
                                </button>
                            </div>
                        `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: var(--space-xl);">
                            <i class="fas fa-link-slash fa-2x" style="margin-bottom: var(--space-md);"></i>
                            <div>Nessun dispositivo collegato</div>
                            <div style="font-size: 0.9rem; margin-top: var(--space-sm);">
                                Usa il QR Code o registra una passkey per collegare dispositivi
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading devices:', error);
                document.getElementById('devicesList').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        Errore caricamento dispositivi
                    </div>
                `;
            }
        }

        async function unlinkDevice(deviceId) {
            if (!confirm('Sei sicuro di voler scollegare questo dispositivo?')) return;

            try {
                const response = await fetch(`/admin/api/auth/devices/${deviceId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Dispositivo scollegato', 'success');
                    loadLinkedDevices();
                } else {
                    throw new Error('Unlink failed');
                }

            } catch (error) {
                console.error('Error unlinking device:', error);
                showNotification('Errore', 'Impossibile scollegare il dispositivo', 'error');
            }
        }

        function toggle2FA(enabled) {
            console.log('2FA toggled:', enabled);
            if (enabled) {
                showNotification('Info', '2FA abilitato (in sviluppo)', 'info');
            } else {
                showNotification('Info', '2FA disabilitato', 'info');
            }
        }

        function toggleSessionMonitoring(enabled) {
            console.log('Session monitoring toggled:', enabled);
            if (enabled) {
                showNotification('Info', 'Monitoraggio sessioni abilitato', 'info');
            } else {
                showNotification('Info', 'Monitoraggio sessioni disabilitato', 'info');
            }
        }

        async function showAuthLogs() {
            // Show authentication logs in a modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h4 class="modal-title">Log Autenticazione</h4>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div id="authLogsContent" class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Caricamento log autenticazione...</div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Load auth logs (filter system logs by auth category)
            loadAuthLogs();

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function loadAuthLogs() {
            try {
                const response = await fetch('/admin/api/logs?type=all&period=24h', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const logs = await response.json();

                    // Filter auth-related logs
                    const authLogs = logs.filter(log =>
                        log.category && (
                            log.category.toLowerCase().includes('auth') ||
                            log.category.toLowerCase().includes('login') ||
                            log.category.toLowerCase().includes('security')
                        )
                    );

                    let html = `<h5>Log Autenticazione (${authLogs.length})</h5>`;

                    if (authLogs.length === 0) {
                        html += '<div style="text-align: center; color: var(--text-muted); padding: var(--space-xl);">Nessun log autenticazione trovato</div>';
                    } else {
                        authLogs.forEach(log => {
                            const logClass = log.level.toLowerCase();
                            html += `
                                <div style="display: flex; gap: var(--space-md); padding: var(--space-sm) 0; border-bottom: 1px solid var(--border); align-items: flex-start;">
                                    <div style="font-weight: 600; color: var(--${logClass === 'error' ? 'error' : logClass === 'warning' ? 'warning' : 'info'}); min-width: 80px;">
                                        ${log.level}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="color: var(--text-primary); margin-bottom: var(--space-xs);">
                                            ${escapeHtml(log.message)}
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            ${new Date(log.timestamp).toLocaleString('it-IT')} - ${log.category || 'Sistema'}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    document.getElementById('authLogsContent').innerHTML = html;
                } else {
                    document.getElementById('authLogsContent').innerHTML = `
                        <div style="text-align: center; color: var(--error);">
                            Errore caricamento log
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading auth logs:', error);
                document.getElementById('authLogsContent').innerHTML = `
                    <div style="text-align: center; color: var(--error);">
                        Errore caricamento log
                    </div>
                `;
            }
        }

        async function revokeAllSessions() {
            if (!confirm('Revocare TUTTE le sessioni attive? Verrai disconnesso da tutti i dispositivi.')) return;

            try {
                showNotification('Info', 'Revocando tutte le sessioni...', 'warning');

                const response = await fetch('/admin/api/auth/revoke-all-sessions', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Successo', 'Tutte le sessioni revocate. Verrai reindirizzato al login.', 'success');
                    setTimeout(() => window.location.href = '/admin/login', 2000);
                } else {
                    throw new Error('Revoke failed');
                }

            } catch (error) {
                console.error('Error revoking sessions:', error);
                showNotification('Errore', 'Impossibile revocare le sessioni', 'error');
            }
        }

        async function emergencyLockdown() {
            const confirmText = `🚨 LOCKDOWN EMERGENZA 🚨\n\nQuesta azione bloccherà immediatamente tutti gli accessi al sistema!\n\n• Tutti gli utenti verranno disconnessi\n• L'accesso admin verrà temporaneamente bloccato\n• Verrà inviato un alert di sicurezza\n\nSei sicuro di voler attivare il lockdown?`;

            if (!confirm(confirmText)) return;

            try {
                showNotification('Avviso', 'Attivando lockdown emergenza...', 'error');

                const response = await fetch('/admin/api/auth/emergency-lockdown', {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    showNotification('Completato', 'Lockdown emergenza attivato. Sistema bloccato.', 'error');
                    setTimeout(() => window.location.href = '/admin/login', 3000);
                } else {
                    throw new Error('Lockdown failed');
                }

            } catch (error) {
                console.error('Error activating lockdown:', error);
                showNotification('Errore', 'Impossibile attivare il lockdown', 'error');
            }
        }

        // Analytics Functions
        let messagesHourlyChart = null;
        let messagesStatusChart = null;

        async function loadAdvancedAnalytics() {
            try {
                console.log('Loading advanced analytics...');

                const response = await fetch('/admin/api/analytics/dashboard', {
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    const analytics = await response.json();
                    console.log('Analytics loaded:', analytics);

                    // Update analytics display
                    updateAnalyticsDisplay(analytics);

                    // Initialize charts
                    initializeCharts(analytics);
                } else {
                    console.error('Failed to load analytics');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateAnalyticsDisplay(analytics) {
            // Update user activity stats
            const users24h = analytics.users_24h || 0;
            const users7d = analytics.users_7d || 0;
            const users30d = analytics.users_30d || 0;

            // Update performance stats
            const cpuUsage = analytics.cpu_usage || 0;
            const ramUsage = analytics.ram_usage || 0;
            const dbConnections = analytics.db_connections || 0;

            // Update security stats
            const failedLogins = analytics.failed_logins_24h || 0;
            const securityAlerts = analytics.security_alerts || 0;
            const auditEvents = analytics.audit_events_24h || 0;

            // Update traffic stats
            const uniqueIPs = analytics.unique_ips_24h || 0;
            const topCountry = analytics.top_country || 'N/A';
            const trafficTrend = analytics.traffic_trend || 0;

            // For now, just log the analytics - you can expand this to update the UI
            console.log('Analytics display updated:', {
                users: { users24h, users7d, users30d },
                performance: { cpuUsage, ramUsage, dbConnections },
                security: { failedLogins, securityAlerts, auditEvents },
                traffic: { uniqueIPs, topCountry, trafficTrend }
            });
        }

        function initializeCharts(analytics) {
            // Destroy existing charts if they exist
            if (messagesHourlyChart) {
                messagesHourlyChart.destroy();
            }
            if (messagesStatusChart) {
                messagesStatusChart.destroy();
            }

            // Messages per hour chart
            const hourlyCtx = document.getElementById('messagesHourlyChart');
            if (hourlyCtx) {
                const hourlyData = analytics.messages_hourly || [];
                messagesHourlyChart = new Chart(hourlyCtx, {
                    type: 'line',
                    data: {
                        labels: hourlyData.map(item => item.hour + ':00'),
                        datasets: [{
                            label: 'Messaggi per Ora',
                            data: hourlyData.map(item => item.count),
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // Messages status chart
            const statusCtx = document.getElementById('messagesStatusChart');
            if (statusCtx) {
                const statusData = analytics.messages_by_status || {};
                messagesStatusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pending', 'Approved', 'Rejected'],
                        datasets: [{
                            data: [
                                statusData.PENDING || 0,
                                statusData.APPROVED || 0,
                                statusData.REJECTED || 0
                            ],
                            backgroundColor: [
                                'var(--warning)',
                                'var(--success)',
                                'var(--error)'
                            ],
                            borderWidth: 2,
                            borderColor: 'var(--bg-primary)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize analytics when settings section is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load analytics when settings tab is shown
            const settingsTab = document.querySelector('[data-section="settings"]');
            if (settingsTab) {
                settingsTab.addEventListener('click', function() {
                    setTimeout(() => {
                        loadAdvancedAnalytics();
                    }, 100);
                });
            }
        });

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const titleEl = notification.querySelector('.notification-title');
            const messageEl = notification.querySelector('.notification-message');
            const iconEl = notification.querySelector('.notification-icon');

            titleEl.textContent = title;
            messageEl.textContent = message;

            // Update icon and colors
            notification.className = `notification ${type}`;
            iconEl.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' :
                              type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' :
                              type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' :
                              '<i class="fas fa-info-circle"></i>';

            // Show notification
            notification.classList.add('show');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function exportData() {
            // Simple export functionality
            const data = {
                messages: allMessages,
                exportDate: new Date().toISOString(),
                totalMessages: allMessages.length
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `insta_spotter_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Successo', 'Dati esportati con successo', 'success');
        }

        function viewMessageDetails(id) {
            const message = allMessages.find(m => m.id === id);
            if (!message) return;

            // Simple modal for message details
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Dettagli Messaggio #${message.id}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="margin: var(--space-lg) 0;">
                        <div style="margin-bottom: var(--space-lg);">
                            <strong>Status:</strong>
                            <span class="message-status status-${message.status.toLowerCase()}" style="margin-left: var(--space-sm);">${message.status}</span>
                        </div>
                        <div style="margin-bottom: var(--space-lg);">
                            <strong>Testo:</strong>
                            <div style="margin-top: var(--space-sm); padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius);">${escapeHtml(message.text)}</div>
                        </div>
                        <div style="margin-bottom: var(--space-lg);">
                            <strong>Data Creazione:</strong> ${new Date(message.created_at).toLocaleString('it-IT')}
                        </div>
                        <div style="margin-bottom: var(--space-lg);">
                            <strong>IP Address:</strong> ${message.ip_address || 'N/A'}
                        </div>
                        ${message.gemini_analysis ? `
                            <div>
                                <strong>Analisi AI:</strong>
                                <div style="margin-top: var(--space-sm); padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius);">${escapeHtml(message.gemini_analysis)}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Logout function
        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                fetch('/admin/logout', { method: 'POST' })
                    .then(() => location.href = '/admin/login')
                    .catch(() => location.href = '/admin/login');
            }
        }
    </script>
</body>
</html>